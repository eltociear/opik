# Using Opik with Langchain

For this guide, we will be performing a text to sql query generation task using LangChain. We will be using the Chinook database which contains the SQLite database of a music store with both employee, customer and invoice data.

We will highlight three different parts of the workflow:

1. Creating a synthetic dataset of questions
2. Creating a LangChain chain to generate SQL queries
3. Automating the evaluation of the SQL queries on the synthetic dataset

## Creating an account on Comet.com

[Comet](https://www.comet.com/site?from=llm&utm_source=opik&utm_medium=colab&utm_content=langchain) provides a hosted version of the Opik platform, [simply create an account](https://www.comet.com/signup?from=llm&utm_source=opik&utm_medium=colab&utm_content=langchain) and grab you API Key.

> You can also run the Opik platform locally, see the [installation guide](https://www.comet.com/docs/opik/self-host/overview/?from=llm&utm_source=opik&utm_medium=colab&utm_content=langchain) for more information.


```python
%pip install --upgrade --quiet opik langchain langchain-community langchain-openai
```

    Note: you may need to restart the kernel to use updated packages.



```python
import opik

opik.configure(use_local=False)
```

    OPIK: Opik is already configured, you can check the settings by viewing the config file at /Users/jacquesverre/.opik.config


## Preparing our environment

First, we will download the Chinook database and set up our different API keys.


```python
import os
import getpass

if "OPENAI_API_KEY" not in os.environ:
    os.environ["OPENAI_API_KEY"] = getpass.getpass("Enter your OpenAI API key: ")
```


```python
# Download the relevant data
import os
from langchain_community.utilities import SQLDatabase

import requests
import os

url = "https://github.com/lerocha/chinook-database/raw/master/ChinookDatabase/DataSources/Chinook_Sqlite.sqlite"
filename = "./data/chinook/Chinook_Sqlite.sqlite"

folder = os.path.dirname(filename)

if not os.path.exists(folder):
    os.makedirs(folder)

if not os.path.exists(filename):
    response = requests.get(url)
    with open(filename, 'wb') as file:
        file.write(response.content)
    print(f"Chinook database downloaded")
    
db = SQLDatabase.from_uri(f"sqlite:///{filename}")
```

## Creating a synthetic dataset

In order to create our synthetic dataset, we will be using the OpenAI API to generate 20 different questions that a user might ask based on the Chinook database.

In order to ensure that the OpenAI API calls are being tracked, we will be using the `track_openai` function from the `opik` library.


```python
from opik.integrations.openai import track_openai
from openai import OpenAI
import json

os.environ["OPIK_PROJECT_NAME"] = "langchain-integration-demo"
client = OpenAI()

openai_client = track_openai(client)

prompt = """
Create 20 different example questions a user might ask based on the Chinook Database.

These questions should be complex and require the model to think. They should include complex joins and window functions to answer.

Return the response as a json object with a "result" key and an array of strings with the question.
"""

completion = openai_client.chat.completions.create(
  model="gpt-3.5-turbo",
  messages=[
    {"role": "user", "content": prompt}
  ]
)

print(completion.choices[0].message.content)
```

    {
      "result": [
        "What is the total revenue generated by each genre in the Chinook database?",
        "What are the top 5 best selling tracks of all time?",
        "Which customer has spent the most money at the store?",
        "How many unique albums have been sold in each country?",
        "What is the average number of tracks in each playlist?",
        "Which employee has sold the most tracks in the past year?",
        "Which artist has the highest average track rating?",
        "What is the distribution of customers by country?",
        "Which genre has the highest average track duration?",
        "What is the average revenue per customer for each country?",
        "How many tracks have been purchased on each day of the week?",
        "Which track has been played the most number of times?",
        "What is the average revenue per track for each genre?",
        "What is the average revenue per customer for each employee?",
        "Which customer has the highest average track rating?",
        "Which artist has the highest total revenue from track sales?",
        "What is the average track rating for each genre?",
        "What is the average revenue per customer from each genre?",
        "Which employee has the highest average track rating?",
        "How does the number of tracks purchased vary by year?"
      ]
    }


Now that we have our synthetic dataset, we can create a dataset in Comet and insert the questions into it.


```python
# Create the synthetic dataset
import opik
from opik import DatasetItem

synthetic_questions = json.loads(completion.choices[0].message.content)["result"]

client = opik.Opik()
try:
    dataset = client.create_dataset(name="synthetic_questions")
    dataset.insert([
        DatasetItem(input={"question": question}) for question in synthetic_questions
    ])
except opik.rest_api.core.ApiError as e:
    print("Dataset already exists")
```

    Dataset already exists


## Creating a LangChain chain

We will be using the `create_sql_query_chain` function from the `langchain` library to create a SQL query to answer the question.

We will be using the `OpikTracer` class from the `opik` library to ensure that the LangChan trace are being tracked in Comet.


```python
# Use langchain to create a SQL query to answer the question
from langchain.chains import create_sql_query_chain
from langchain_openai import ChatOpenAI
from opik.integrations.langchain import OpikTracer

opik_tracer = OpikTracer(tags=["simple_chain"])

llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0)
chain = create_sql_query_chain(llm, db).with_config({"callbacks": [opik_tracer]})
response = chain.invoke({"question": "How many employees are there ?"})
response

print(response)
```

    SELECT COUNT("EmployeeId") AS "TotalEmployees" FROM "Employee"


## Automatting the evaluation

In order to ensure our LLM application is working correctly, we will test it on our synthetic dataset.

For this we will be using the `evaluate` function from the `opik` library. We will evaluate the application using a custom metric that checks if the SQL query is valid.


```python
from opik import Opik, track
from opik.evaluation import evaluate
from opik.evaluation.metrics import base_metric, score_result
from typing import Any

class ValidSQLQuery(base_metric.BaseMetric):
    def __init__(self, name: str, db: Any):
        self.name = name
        self.db = db

    def score(self, output: str, **ignored_kwargs: Any):
        # Add you logic here

        try:
            db.run(output)
            return score_result.ScoreResult(
                name=self.name,
                value=1,
                reason="Query ran successfully"
            )
        except Exception as e:
            return score_result.ScoreResult(
                name=self.name,
                value=0,
                reason=str(e)
            )

valid_sql_query = ValidSQLQuery(name="valid_sql_query", db=db)

client = Opik()
dataset = client.get_dataset("synthetic_questions")

@track()
def llm_chain(input: str) -> str:
    response = chain.invoke({"question": input})
    
    return response

def evaluation_task(item):
    response = llm_chain(item.input["question"])

    return {
        "reference": "hello",
        "output": response
    }

res = evaluate(
    experiment_name="SQL question answering",
    dataset=dataset,
    task=evaluation_task,
    scoring_metrics=[valid_sql_query]
)
```

    Evaluation: 100%|██████████| 20/20 [00:02<00:00,  7.55it/s]



<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">╭─ synthetic_questions (20 samples) ─╮
│                                    │
│ <span style="font-weight: bold">Total time:       </span> 00:00:03        │
│ <span style="font-weight: bold">Number of samples:</span> 20              │
│                                    │
│ <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">valid_sql_query: 0.8500 (avg)</span>      │
│                                    │
╰────────────────────────────────────╯
</pre>




<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Uploading results to Opik <span style="color: #808000; text-decoration-color: #808000">...</span> 
</pre>




    ---------------------------------------------------------------------------

    UnboundLocalError                         Traceback (most recent call last)

    Cell In[7], line 47
         40     response = llm_chain(item.input["question"])
         42     return {
         43         "reference": "hello",
         44         "output": response
         45     }
    ---> 47 res = evaluate(
         48     experiment_name="SQL question answering",
         49     dataset=dataset,
         50     task=evaluation_task,
         51     scoring_metrics=[valid_sql_query]
         52 )


    File /opt/homebrew/Caskroom/miniconda/base/envs/py312_llm_eval/lib/python3.12/site-packages/opik/evaluation/evaluator.py:68, in evaluate(dataset, task, scoring_metrics, experiment_name, experiment_config, verbose, task_threads)
         64     report.display_experiment_results(dataset.name, total_time, test_results)
         66 scores_logger.log_scores(client=client, test_results=test_results)
    ---> 68 experiment = client.create_experiment(
         69     name=experiment_name,
         70     dataset_name=dataset.name,
         71     experiment_config=experiment_config,
         72 )
         73 experiment_items = [
         74     experiment_item.ExperimentItem(
         75         dataset_item_id=result.test_case.dataset_item_id,
       (...)
         78     for result in test_results
         79 ]
         81 experiment.insert(experiment_items=experiment_items)


    File /opt/homebrew/Caskroom/miniconda/base/envs/py312_llm_eval/lib/python3.12/site-packages/opik/api_objects/opik_client.py:377, in Opik.create_experiment(self, name, dataset_name, experiment_config)
        367     LOGGER.error(
        368         "Experiment config must be dictionary, but %s was provided. Config will not be logged.",
        369         experiment_config,
        370     )
        371     metadata = None
        373 self._rest_client.experiments.create_experiment(
        374     name=name,
        375     dataset_name=dataset_name,
        376     id=id,
    --> 377     metadata=metadata,
        378 )
        380 experiment_ = experiment.Experiment(
        381     id=id,
        382     name=name,
        383     dataset_name=dataset_name,
        384     rest_client=self._rest_client,
        385 )
        387 return experiment_


    UnboundLocalError: cannot access local variable 'metadata' where it is not associated with a value


The evaluation results are now uploaded to the Opik platform and can be viewed in the UI.

![LangChain Evaluation](https://raw.githubusercontent.com/comet-ml/opik/main/apps/opik-documentation/documentation/static/img/cookbook/langchain_cookbook.png)


